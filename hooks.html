
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Hooks &#8212; pubtools  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Developer Guide" href="devguide.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="hooks">
<span id="id1"></span><h1><a class="toc-backref" href="#id2">Hooks</a><a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#hooks" id="id2">Hooks</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id3">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#guide-hook-providers" id="id4">Guide: hook providers</a></p></li>
<li><p><a class="reference internal" href="#guide-hook-implementers" id="id5">Guide: hook implementers</a></p></li>
<li><p><a class="reference internal" href="#guide-managing-context" id="id6">Guide: managing context</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-reference" id="id7">API reference</a></p></li>
<li><p><a class="reference internal" href="#hook-reference" id="id8">Hook reference</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id3">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>pubtools projects can be extended via a hook/event/callback system
based on <a class="reference external" href="https://pluggy.readthedocs.io/">pluggy</a>.</p>
<p>This system is mainly intended for use as a publish-subscribe event dispatcher
and enables the following scenarios:</p>
<ul class="simple">
<li><p>When something happens in <code class="docutils literal notranslate"><span class="pre">pubtools-foo</span></code>, trigger some code in <code class="docutils literal notranslate"><span class="pre">pubtools-bar</span></code>,
without <code class="docutils literal notranslate"><span class="pre">pubtools-foo</span></code> having a direct dependency on <code class="docutils literal notranslate"><span class="pre">pubtools-bar</span></code>.</p></li>
<li><p>When something happens in <code class="docutils literal notranslate"><span class="pre">pubtools-foo</span></code>, trigger some code in
<a class="reference internal" href="devguide.html#hosted"><span class="std std-ref">the hosting service</span></a> if the task is running hosted; otherwise, do
nothing.</p></li>
</ul>
<p>All features provided by pluggy may be used as normal.
The next few sections provide a crash course on basic usage of pluggy.</p>
<section id="guide-hook-providers">
<h3><a class="toc-backref" href="#id4">Guide: hook providers</a><a class="headerlink" href="#guide-hook-providers" title="Permalink to this headline">¶</a></h3>
<p>If you are implementing a <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> project and you want to provide hooks
(which can also be considered “emitting events”), you should do the following:</p>
<section id="define-hookspecs">
<h4>1. Define hookspecs<a class="headerlink" href="#define-hookspecs" title="Permalink to this headline">¶</a></h4>
<p>You need to specify your hooks before using them. This can be done by defining
some functions with <code class="docutils literal notranslate"><span class="pre">&#64;hookspec</span></code> decorator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the pluggy objects bound to &#39;pubtools&#39; namespace</span>
<span class="kn">from</span> <span class="nn">pubtools.pluggy</span> <span class="kn">import</span> <span class="n">pm</span><span class="p">,</span> <span class="n">hookspec</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Define a hookspec. This is just a plain old function, typically</span>
<span class="c1"># with an empty implementation (only doc string).</span>
<span class="c1">#</span>
<span class="c1"># The doc string should explain the circumstances under which this</span>
<span class="c1"># hook is invoked.</span>

<span class="nd">@hookspec</span>
<span class="k">def</span> <span class="nf">kettle_on</span><span class="p">(</span><span class="n">kettle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Called immediately before a kettle is turned on.&quot;&quot;&quot;</span>

<span class="nd">@hookspec</span>
<span class="k">def</span> <span class="nf">kettle_off</span><span class="p">(</span><span class="n">kettle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Called after a kettle has been turned off.&quot;&quot;&quot;</span>

<span class="c1"># Add these hookspecs onto the plugin manager.</span>
<span class="n">pm</span><span class="o">.</span><span class="n">add_hookspecs</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">module</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Be aware that:</p>
<ul class="simple">
<li><p>There is one flat namespace for hooks across all <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> projects, so you must
take care to avoid name clashes</p></li>
<li><p>You must ensure that the module containing your hookspecs is imported when your library
is imported. If you forget to import the module, your hooks won’t be available.</p></li>
</ul>
</section>
<section id="invoke-hooks">
<h4>2. Invoke hooks<a class="headerlink" href="#invoke-hooks" title="Permalink to this headline">¶</a></h4>
<p>At the appropriate times according to the documented behavior of your hooks,
invoke them via <code class="docutils literal notranslate"><span class="pre">pm.hook</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pubtools.pluggy</span> <span class="kn">import</span> <span class="n">pm</span>

<span class="k">def</span> <span class="nf">make_tea</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
   <span class="n">kettle</span><span class="o">.</span><span class="n">fill_water</span><span class="p">()</span>

   <span class="c1"># notify anyone interested that we&#39;re turning the kettle on</span>
   <span class="n">pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">kettle_on</span><span class="p">(</span><span class="n">kettle</span><span class="p">)</span>

   <span class="n">kettle</span><span class="o">.</span><span class="n">start_boil</span><span class="p">()</span>
   <span class="n">kettle</span><span class="o">.</span><span class="n">wait_boil</span><span class="p">()</span>

   <span class="c1"># notify again</span>
   <span class="n">pm</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">kettle_off</span><span class="p">(</span><span class="n">kettle</span><span class="p">)</span>

   <span class="c1"># Proceed as normal</span>
   <span class="n">cup</span><span class="o">.</span><span class="n">fill_water</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">kettle</span><span class="p">)</span>
   <span class="c1"># (...)</span>
</pre></div>
</div>
<p>When a hook is called, any plugins with matching registered <code class="docutils literal notranslate"><span class="pre">&#64;hookimpls</span></code> will be
invoked in LIFO order. If no plugins have registered, nothing will happen.</p>
<p>The above example shows a pure event emitter. More advanced patterns are possible,
such as making use of values returned by hooks. See the pluggy documentation for
more information.</p>
</section>
</section>
<section id="guide-hook-implementers">
<h3><a class="toc-backref" href="#id5">Guide: hook implementers</a><a class="headerlink" href="#guide-hook-implementers" title="Permalink to this headline">¶</a></h3>
<p>If you want to implement hooks (which can also be considered as “receiving events”),
you need to declare hook implementations in your project and register them with
the pubtools plugin manager. Note that it is not necessary for a project to belong
to the <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> project family in order to do this.</p>
<p>Hook implementations can be defined using the <code class="docutils literal notranslate"><span class="pre">&#64;hookimpl</span></code> decorator. The function
names and signatures should match exactly the names of the corresponding hookspecs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the pluggy objects bound to &#39;pubtools&#39; namespace</span>
<span class="kn">from</span> <span class="nn">pubtools.pluggy</span> <span class="kn">import</span> <span class="n">pm</span><span class="p">,</span> <span class="n">hookimpl</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Define a hookimpl. Match exactly the hookspecs declared</span>
<span class="c1"># in the previous example.</span>

<span class="nd">@hookimpl</span>
<span class="k">def</span> <span class="nf">kettle_on</span><span class="p">(</span><span class="n">kettle</span><span class="p">):</span>
    <span class="c1"># Kettle causes huge spike in power consumption, we&#39;d better</span>
    <span class="c1"># enable the power reserves.</span>
    <span class="c1"># https://en.wikipedia.org/wiki/TV_pickup</span>
    <span class="n">powerbank</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="nd">@hookimpl</span>
<span class="k">def</span> <span class="nf">kettle_off</span><span class="p">(</span><span class="n">kettle</span><span class="p">):</span>
    <span class="c1"># Don&#39;t need the extra power any more</span>
    <span class="n">powerbank</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

<span class="c1"># Register this module as a plugin.</span>
<span class="n">pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Be aware that:</p>
<ul class="simple">
<li><p>Your hookimpl could be invoked by any thread. Blocking the current thread
may be inappropriate. It’s best to do only small amounts of work
within a hookimpl.</p></li>
<li><p>If your hookimpl raises an exception, it will propagate upwards through
to the hook caller.</p></li>
</ul>
</section>
<section id="guide-managing-context">
<h3><a class="toc-backref" href="#id6">Guide: managing context</a><a class="headerlink" href="#guide-managing-context" title="Permalink to this headline">¶</a></h3>
<p>In the above naive example, hookimpls are standalone functions within a module,
with no mechanism for passing context between themselves.
For instance, the above example can’t maintain a count of boiling kettles
(excluding antipatterns such as mutating globals).</p>
<p>A more realistic approach of registering hookimpls which allows passing around
some context is to register your plugins in a two-stage process:</p>
<ul class="simple">
<li><p>First, attach to some initial event allowing you to establish context.
pubtools provides <a class="reference internal" href="#task_start" title="task_start"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_start()</span></code></a> for this purpose.</p></li>
<li><p>When that hook is invoked, set up desired context and then register additional hooks.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the pluggy objects bound to &#39;pubtools&#39; namespace</span>
<span class="kn">from</span> <span class="nn">pubtools.pluggy</span> <span class="kn">import</span> <span class="n">pm</span><span class="p">,</span> <span class="n">hookimpl</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">KettleSpikeHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Do anything I like here - configure myself from</span>
        <span class="c1"># settings, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powerbank</span> <span class="o">=</span> <span class="p">(</span><span class="o">...</span><span class="p">)</span>

        <span class="c1"># We can now maintain state between hookimpls.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kettlecount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Instance methods work OK for hookimpls.</span>

    <span class="nd">@hookimpl</span>
    <span class="k">def</span> <span class="nf">kettle_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kettle</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kettlecount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powerbank</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="nd">@hookimpl</span>
    <span class="k">def</span> <span class="nf">kettle_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kettle</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kettlecount</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kettlecount</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">powerbank</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

<span class="nd">@hookimpl</span>
<span class="k">def</span> <span class="nf">task_start</span><span class="p">():</span>
    <span class="c1"># When task starts, we register an instance of this object</span>
    <span class="c1"># as an additional plugin. This allows the object to keep</span>
    <span class="c1"># its own state between calls to different hookimpls.</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">KettleSpikeHandler</span><span class="p">())</span>

<span class="c1"># Register this module as a plugin.</span>
<span class="c1"># This will only register the top-level &#39;task_start&#39; hookimpl.</span>
<span class="n">pm</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p><a class="reference internal" href="#task_start" title="task_start"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_start()</span></code></a> and <a class="reference internal" href="#task_stop" title="task_stop"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_stop()</span></code></a> are two standard hooks intended for
use in setting up or tearing down a plugin context. Note that these are only
conventions and may not be used uniformly across all pubtools task libraries.</p>
</section>
</section>
<section id="api-reference">
<h2><a class="toc-backref" href="#id7">API reference</a><a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<dl class="py attribute">
<dt class="sig sig-object py" id="pubtools.pluggy.pm">
<span class="sig-prename descclassname"><span class="pre">pubtools.pluggy.</span></span><span class="sig-name descname"><span class="pre">pm</span></span><a class="headerlink" href="#pubtools.pluggy.pm" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://pluggy.readthedocs.io/en/latest/api_reference.html#pluggy.PluginManager" title="(in pluggy v1.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pluggy.PluginManager</span></code></a></p>
</dd>
</dl>
<p>A PluginManager configured for the <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> namespace.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="pubtools.pluggy.hookspec">
<span class="sig-prename descclassname"><span class="pre">pubtools.pluggy.</span></span><span class="sig-name descname"><span class="pre">hookspec</span></span><a class="headerlink" href="#pubtools.pluggy.hookspec" title="Permalink to this definition">¶</a></dt>
<dd><p>A hookspec decorator configured for the <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> namespace.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="pubtools.pluggy.hookimpl">
<span class="sig-prename descclassname"><span class="pre">pubtools.pluggy.</span></span><span class="sig-name descname"><span class="pre">hookimpl</span></span><a class="headerlink" href="#pubtools.pluggy.hookimpl" title="Permalink to this definition">¶</a></dt>
<dd><p>A hookimpl decorator configured for the <code class="docutils literal notranslate"><span class="pre">pubtools</span></code> namespace.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pubtools.pluggy.task_context">
<span class="sig-prename descclassname"><span class="pre">pubtools.pluggy.</span></span><span class="sig-name descname"><span class="pre">task_context</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/pubtools/_impl/pluggy.html#task_context"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pubtools.pluggy.task_context" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a block of code within a task context, ensuring task lifecycle hooks are invoked
when appropriate.</p>
<p>This is a context manager for use within pubtools task libraries where hooks
shall be provided. It can be used in a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, as in example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">task_context</span><span class="p">():</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="bp">self</span><span class="o">.</span><span class="n">do_task</span><span class="p">()</span>
</pre></div>
</div>
<p>The context manager will ensure that:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#task_start" title="task_start"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_start()</span></code></a> is invoked when the block is entered.</p></li>
<li><p><a class="reference internal" href="#task_stop" title="task_stop"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_stop()</span></code></a> is invoked when the block is exited.</p></li>
</ul>
</dd></dl>

</section>
<section id="hook-reference">
<h2><a class="toc-backref" href="#id8">Hook reference</a><a class="headerlink" href="#hook-reference" title="Permalink to this headline">¶</a></h2>
<p>This section lists all known hooks defined in the pubtools
namespace.</p>
<dl class="py function">
<dt class="sig sig-object py" id="task_start">
<span class="sig-name descname"><span class="pre">task_start</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#task_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a task starts.</p>
<p>This hook can be used to register additional hook implementations with
desired context.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="task_stop">
<span class="sig-name descname"><span class="pre">task_stop</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">failed</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#task_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a task ends.</p>
<p>If <a class="reference internal" href="#task_start" title="task_start"><code class="xref py py-func docutils literal notranslate"><span class="pre">task_start()</span></code></a> was used to register additional hook implementations,
this hook should be used to unregister them.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>failed</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)"><em>bool</em></a>) – True if the task is failing (i.e. exiting with non-zero exit code, or
raising an exception).</p>
</dd>
</dl>
</dd></dl>

</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pubtools</a></h1>



<p class="blurb">Publishing tools project family</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="projects.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="devguide.html">Developer Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hooks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-reference">API reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hook-reference">Hook reference</a></li>
</ul>
</li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/release-engineering/pubtools">Source</a></li>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/pubtools">PyPI</a></li>
    
    <li class="toctree-l1"><a href="genindex.html">Index</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="devguide.html" title="previous chapter">Developer Guide</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Red Hat.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/hooks.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/release-engineering/pubtools" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>